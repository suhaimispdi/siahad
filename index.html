<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Absensi Siswa SMPS IT Imam Syafi'i</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link rel="icon" type="image/x-icon" href="/favicon.ico?v=3">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    *{font-family:'Inter',sans-serif}
    .gradient-bg{background:linear-gradient(135deg,#e0f2fe 0%,#f3e5f5 50%,#e8f5e8 100%)}
    .card-shadow{box-shadow:0 4px 20px rgba(0,0,0,.08)}
    .hover-lift{transition:all .3s ease}
    .hover-lift:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(0,0,0,.12)}
    .animate-fade-in{animation:fadeIn .6s ease-out}
    @keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    .loading-spinner{border:3px solid #e3f2fd;border-top:3px solid #2196f3;border-radius:50%;width:24px;height:24px;animation:spin 1s linear infinite}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .nav-item{transition:all .25s ease}
    .nav-item:hover{background:rgba(59,130,246,0.08);color:#2563eb}
    .nav-item.active{background:linear-gradient(135deg,#3b82f6,#1d4ed8);color:#fff;box-shadow:0 4px 12px rgba(59,130,246,.3)}
    .nav-item.active:hover{background:linear-gradient(135deg,#1d4ed8,#1e40af);color:#fff}
    .stats-card{background:linear-gradient(135deg,var(--bg-from),var(--bg-to))}
    .btn-primary{background:linear-gradient(135deg,#42a5f5,#1e88e5);transition:all .3s ease}
    .btn-primary:hover{background:linear-gradient(135deg,#1e88e5,#1565c0);transform:translateY(-1px)}
    .btn-success{background:linear-gradient(135deg,#66bb6a,#43a047);transition:all .3s ease}
    .btn-success:hover{background:linear-gradient(135deg,#43a047,#2e7d32);transform:translateY(-1px)}
    .btn-warning{background:linear-gradient(135deg,#ffa726,#ff9800);transition:all .3s ease}
    .btn-warning:hover{background:linear-gradient(135deg,#ff9800,#f57c00);transform:translateY(-1px)}
    .btn-danger{background:linear-gradient(135deg,#ef5350,#e53935);transition:all .3s ease}
    .btn-danger:hover{background:linear-gradient(135deg,#e53935,#c62828);transform:translateY(-1px)}
    .table-container{background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 4px 20px rgba(0,0,0,.08)}
    .table-header{background:linear-gradient(135deg,#f8fafc,#e2e8f0)}
    .form-input{transition:all .3s ease;border:2px solid #e2e8f0}
    .form-input:focus{border-color:#42a5f5;box-shadow:0 0 0 3px rgba(66,165,245,.1)}
    @media (max-width:768px){.stats-grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media (max-width:1024px){.nav-grid{grid-template-columns:repeat(3,minmax(0,1fr))}}
    @media (max-width:480px){.nav-grid{grid-template-columns:repeat(3,minmax(0,1fr))}.nav-item span{font-size:11px}}
  </style>
</head>
<body class="gradient-bg min-h-screen">
  <!-- Login Page -->
  <div id="loginPage" class="min-h-screen flex items-center justify-center p-4">
    <div class="bg-white/90 backdrop-blur-md rounded-3xl card-shadow p-8 w-full max-w-md">
      <div class="text-center mb-8">
        <div class="w-20 h-20 mx-auto mb-4 rounded-2xl overflow-hidden flex items-center justify-center shadow-lg">
          <img src="https://iili.io/KooKJn9.jpg" alt="Logo SMPS IT Imam Syafi'i" class="w-full h-full object-cover" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
          <div class="w-20 h-20 bg-gradient-to-br from-blue-500 to-purple-600 rounded-2xl flex items-center justify-center" style="display:none">
            <i class="fas fa-graduation-cap text-white text-2xl"></i>
          </div>
        </div>
        <h1 class="text-2xl font-bold text-gray-800 mb-2">Sistem Absensi</h1>
        <p class="text-gray-600">SMPS IT Imam Syafi'i</p>
      </div>

      <form id="loginForm" class="space-y-6">
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2"><i class="fas fa-user mr-2"></i>Username</label>
          <input id="username" type="text" class="form-input w-full px-4 py-3 rounded-xl bg-white border-2 border-gray-200 focus:border-blue-500 focus:ring-0" placeholder="Masukkan username" required>
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2"><i class="fas fa-lock mr-2"></i>Password</label>
          <div class="relative">
            <input id="password" type="password" class="form-input w-full px-4 py-3 pr-12 rounded-xl bg-white border-2 border-gray-200 focus:border-blue-500 focus:ring-0" placeholder="Masukkan password" required>
            <button type="button" onclick="togglePassword()" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700">
              <i id="passwordToggleIcon" class="fas fa-eye"></i>
            </button>
          </div>
        </div>
        <button type="submit" class="w-full btn-primary text-white py-4 rounded-xl font-bold text-lg flex items-center justify-center space-x-3 shadow-lg">
          <i class="fas fa-sign-in-alt"></i><span>Masuk</span>
        </button>

        <div id="loginError" class="mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-xl hidden">
          <div class="flex items-center space-x-2">
            <i class="fas fa-exclamation-circle"></i>
            <span class="font-medium">Username atau password salah!</span>
          </div>
          <p class="text-sm mt-1">Silakan periksa kembali username dan password Anda.</p>
        </div>
      </form>

      <div class="mt-8 text-center">
        <p class="text-xs text-gray-500">Â© 2024 SMPS IT Imam Syafi'i</p>
        <p class="text-xs text-gray-400 mt-1">Sistem Absensi Digital</p>
      </div>
    </div>
  </div>

  <!-- Main App -->
  <div id="mainApp" class="hidden">
    <header class="bg-white/90 backdrop-blur-md shadow-lg sticky top-0 z-50">
      <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white py-4">
        <div class="container mx-auto px-4">
          <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
              <div class="w-12 h-12 rounded-xl overflow-hidden flex items-center justify-center bg-white/20 backdrop-blur-sm">
                <img src="https://iili.io/KooKJn9.jpg" alt="Logo SMPS IT Imam Syafi'i" class="w-full h-full object-cover rounded-xl" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                <div class="w-12 h-12 bg-white/30 rounded-xl flex items-center justify-center" style="display:none">
                  <i class="fas fa-graduation-cap text-white text-xl"></i>
                </div>
              </div>
              <div>
                <h1 class="text-2xl md:text-3xl font-bold">SMPS IT Imam Syafi'i</h1>
                <p class="text-blue-100 text-sm md:text-base">Sistem Absensi Digital</p>
              </div>
            </div>
            <button onclick="logout()" class="bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-xl font-medium flex items-center space-x-2 transition-all duration-300 backdrop-blur-sm">
              <i class="fas fa-sign-out-alt"></i><span class="hidden md:inline">Keluar</span>
            </button>
          </div>
        </div>
      </div>

      <!-- 2-row Navigation -->
      <div class="bg-white/90 backdrop-blur-md border-b border-gray-200">
        <div class="container mx-auto px-4 py-3">
          <nav class="grid nav-grid grid-cols-3 gap-2 md:gap-4">
            <button onclick="showSection('dashboard')" class="nav-item flex flex-col items-center px-3 py-2 rounded-xl text-gray-600 min-w-0 active">
              <i class="fas fa-home text-xl mb-1"></i><span class="text-xs font-medium text-center">Dashboard</span>
            </button>
            <button onclick="showSection('absensi')" class="nav-item flex flex-col items-center px-3 py-2 rounded-xl text-gray-600 min-w-0">
              <i class="fas fa-clipboard-check text-xl mb-1"></i><span class="text-xs font-medium text-center">Absensi</span>
            </button>
            <button onclick="showSection('rekap')" class="nav-item flex flex-col items-center px-3 py-2 rounded-xl text-gray-600 min-w-0">
              <i class="fas fa-chart-bar text-xl mb-1"></i><span class="text-xs font-medium text-center">Rekap</span>
            </button>
            <button onclick="showSection('data-siswa')" class="nav-item flex flex-col items-center px-3 py-2 rounded-xl text-gray-600 min-w-0">
              <i class="fas fa-users text-xl mb-1"></i><span class="text-xs font-medium text-center">Data Siswa</span>
            </button>
            <button onclick="showSection('mata-pelajaran')" class="nav-item flex flex-col items-center px-3 py-2 rounded-xl text-gray-600 min-w-0">
              <i class="fas fa-book text-xl mb-1"></i><span class="text-xs font-medium text-center">Mata Pelajaran</span>
            </button>
            <button onclick="showSection('kepsek')" class="nav-item flex flex-col items-center px-3 py-2 rounded-xl text-gray-600 min-w-0">
              <i class="fas fa-user-tie text-xl mb-1"></i><span class="text-xs font-medium text-center">KepSek</span>
            </button>
          </nav>
        </div>
      </div>
    </header>

    <main class="container mx-auto px-4 py-6">
      <!-- Dashboard -->
      <section id="dashboard-section" class="animate-fade-in">
        <div class="bg-white/80 backdrop-blur-md rounded-2xl card-shadow p-6 mb-6">
          <div class="flex flex-col md:flex-row items-center justify-between">
            <div>
              <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-2">Selamat Datang!</h2>
              <p class="text-gray-600">Dashboard Absensi Siswa SMPS IT Imam Syafi'i</p>
              <p class="text-sm text-gray-500 mt-1" id="currentDateTime"></p>
            </div>
            <div class="mt-4 md:mt-0">
              <button onclick="refreshAllData()" class="btn-primary text-white px-6 py-3 rounded-xl font-medium flex items-center space-x-2">
                <i class="fas fa-sync-alt"></i><span>Refresh Data</span>
              </button>
            </div>
          </div>
        </div>

        <!-- Statistics Cards (2 cols mobile) -->
        <div class="stats-grid grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6 mb-6">
          <!-- Hadir -->
          <div class="stats-card hover-lift rounded-2xl p-5 md:p-6 text-white flex flex-col items-center justify-center text-center" style="--bg-from:#4ade80;--bg-to:#22c55e;">
            <div class="w-12 h-12 md:w-14 md:h-14 bg-white/20 rounded-xl flex items-center justify-center mb-3">
              <i class="fas fa-check-circle text-xl md:text-2xl"></i>
            </div>
            <p class="text-green-50 text-xs md:text-sm tracking-wide">Hadir</p>
            <p class="text-3xl md:text-4xl font-extrabold mt-1" id="totalHadir">-</p>
          </div>
          <!-- Izin -->
          <div class="stats-card hover-lift rounded-2xl p-5 md:p-6 text-white flex flex-col items-center justify-center text-center" style="--bg-from:#fbbf24;--bg-to:#f59e0b;">
            <div class="w-12 h-12 md:w-14 md:h-14 bg-white/20 rounded-xl flex items-center justify-center mb-3">
              <i class="fas fa-hand-paper text-xl md:text-2xl"></i>
            </div>
            <p class="text-yellow-50 text-xs md:text-sm tracking-wide">Izin</p>
            <p class="text-3xl md:text-4xl font-extrabold mt-1" id="totalIzin">-</p>
          </div>
          <!-- Sakit -->
          <div class="stats-card hover-lift rounded-2xl p-5 md:p-6 text-white flex flex-col items-center justify-center text-center" style="--bg-from:#60a5fa;--bg-to:#3b82f6;">
            <div class="w-12 h-12 md:w-14 md:h-14 bg-white/20 rounded-xl flex items-center justify-center mb-3">
              <i class="fas fa-thermometer-half text-xl md:text-2xl"></i>
            </div>
            <p class="text-blue-50 text-xs md:text-sm tracking-wide">Sakit</p>
            <p class="text-3xl md:text-4xl font-extrabold mt-1" id="totalSakit">-</p>
          </div>
          <!-- Alpha -->
          <div class="stats-card hover-lift rounded-2xl p-5 md:p-6 text-white flex flex-col items-center justify-center text-center" style="--bg-from:#f87171;--bg-to:#ef4444;">
            <div class="w-12 h-12 md:w-14 md:h-14 bg-white/20 rounded-xl flex items-center justify-center mb-3">
              <i class="fas fa-times-circle text-xl md:text-2xl"></i>
            </div>
            <p class="text-red-50 text-xs md:text-sm tracking-wide">Alpha</p>
            <p class="text-3xl md:text-4xl font-extrabold mt-1" id="totalAlpha">-</p>
          </div>
        </div>

        <div class="bg-white/80 backdrop-blur-md rounded-2xl card-shadow p-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-bold text-gray-800">Aktivitas Terbaru</h3>
            <button onclick="showSection('rekap')" class="text-blue-600 hover:text-blue-700 font-medium text-sm">
              Lihat Semua <i class="fas fa-arrow-right ml-1"></i>
            </button>
          </div>
          <div class="table-container">
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="table-header">
                  <tr>
                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Tanggal</th>
                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Nama</th>
                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Kelas</th>
                    <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Status</th>
                  </tr>
                </thead>
                <tbody id="recentActivityTable">
                  <tr>
                    <td colspan="4" class="px-4 py-8 text-center text-gray-500">
                      <i class="fas fa-clock text-2xl mb-2 block"></i>Memuat aktivitas terbaru...
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- Absensi -->
      <section id="absensi-section" class="animate-fade-in hidden">
        <div class="bg-white/80 backdrop-blur-md rounded-2xl card-shadow p-6">
          <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
            <i class="fas fa-clipboard-check text-blue-600 mr-3"></i>Form Absensi Siswa
          </h2>

          <form id="absensiForm" class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Kelas</label>
                <select id="kelasSiswa" class="form-input w-full px-4 py-3 rounded-xl bg-white">
                  <option value="">Pilih Kelas</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Mata Pelajaran</label>
                <select id="mataPelajaran" class="form-input w-full px-4 py-3 rounded-xl bg-white">
                  <option value="">Pilih Mata Pelajaran</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Tanggal</label>
                <input id="tanggalAbsen" type="date" class="form-input w-full px-4 py-3 rounded-xl bg-white">
              </div>
            </div>

            <div class="flex flex-col sm:flex-row gap-4 justify-center">
              <button type="button" onclick="filterAbsensi()" class="btn-success text-white px-8 py-3 rounded-xl font-semibold flex items-center justify-center space-x-2">
                <i class="fas fa-search"></i><span>Tampilkan Data</span>
              </button>
              <button type="button" onclick="hadirSemua()" class="btn-primary text-white px-8 py-3 rounded-xl font-semibold flex items-center justify-center space-x-2">
                <i class="fas fa-check-circle"></i><span>Hadir Semua</span>
              </button>
            </div>
          </form>

          <div id="absensiDataContainer" class="mt-8 hidden">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Data Siswa untuk Absensi</h3>
            <div class="table-container">
              <div class="overflow-x-auto">
                <table class="w-full">
                  <thead class="table-header">
                    <tr>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">NIS</th>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Nama Siswa</th>
                      <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">H</th>
                      <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">I</th>
                      <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">S</th>
                      <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">A</th>
                    </tr>
                  </thead>
                  <tbody id="absensiTableBody"></tbody>
                </table>
              </div>
            </div>
            <div class="mt-6 text-center">
              <button type="button" onclick="simpanSemuaAbsensi()" class="btn-primary text-white px-12 py-4 rounded-xl font-semibold text-lg flex items-center justify-center space-x-3 mx-auto">
                <i class="fas fa-save"></i><span>Simpan Semua Absensi</span>
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- Rekap -->
      <section id="rekap-section" class="animate-fade-in hidden">
        <div class="bg-white/80 backdrop-blur-md rounded-2xl card-shadow p-6">
          <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
            <i class="fas fa-chart-bar text-green-600 mr-3"></i>Rekap Absensi
          </h2>

          <div class="bg-gray-50/80 rounded-xl p-6 mb-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Filter Rekap</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Kelas</label>
                <select id="filterKelas" class="form-input w-full px-3 py-2 rounded-lg bg-white">
                  <option value="">Semua Kelas</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Mata Pelajaran</label>
                <select id="filterMataPelajaran" class="form-input w-full px-3 py-2 rounded-lg bg-white">
                  <option value="">Semua Mata Pelajaran</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Dari Tanggal</label>
                <input id="filterDariTanggal" type="date" class="form-input w-full px-3 py-2 rounded-lg bg-white">
              </div>
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Sampai Tanggal</label>
                <input id="filterSampaiTanggal" type="date" class="form-input w-full px-3 py-2 rounded-lg bg-white">
              </div>
            </div>

            <div class="mt-6 flex flex-col sm:flex-row gap-4 justify-center">
              <button onclick="applyRekapFilter()" class="btn-success text-white px-8 py-2 rounded-lg font-semibold flex items-center justify-center space-x-2">
                <i class="fas fa-filter"></i><span>Terapkan Filter</span>
              </button>
              <button onclick="resetRekapFilter()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-semibold flex items-center justify-center space-x-2">
                <i class="fas fa-undo"></i><span>Reset Filter</span>
              </button>
              <button onclick="openRekapSpreadsheet()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-semibold flex items-center justify-center space-x-2 transition-all duration-300">
                <i class="fas fa-table"></i><span>Spreadsheet</span>
              </button>
            </div>
          </div>

          <!-- Filter Stats: same modern 2-col cards -->
          <div id="filterStatsContainer" class="stats-grid grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6 mb-6 hidden">
            <!-- Hadir -->
            <div class="stats-card hover-lift rounded-2xl p-5 md:p-6 text-white flex flex-col items-center justify-center text-center" style="--bg-from:#4ade80;--bg-to:#22c55e;">
              <div class="w-12 h-12 md:w-14 md:h-14 bg-white/20 rounded-xl flex items-center justify-center mb-3">
                <i class="fas fa-check-circle text-xl md:text-2xl"></i>
              </div>
              <p class="text-green-50 text-xs md:text-sm tracking-wide">Hadir</p>
              <p class="text-3xl md:text-4xl font-extrabold mt-1" id="filterHadir">0</p>
            </div>
            <!-- Izin -->
            <div class="stats-card hover-lift rounded-2xl p-5 md:p-6 text-white flex flex-col items-center justify-center text-center" style="--bg-from:#fbbf24;--bg-to:#f59e0b;">
              <div class="w-12 h-12 md:w-14 md:h-14 bg-white/20 rounded-xl flex items-center justify-center mb-3">
                <i class="fas fa-hand-paper text-xl md:text-2xl"></i>
              </div>
              <p class="text-yellow-50 text-xs md:text-sm tracking-wide">Izin</p>
              <p class="text-3xl md:text-4xl font-extrabold mt-1" id="filterIzin">0</p>
            </div>
            <!-- Sakit -->
            <div class="stats-card hover-lift rounded-2xl p-5 md:p-6 text-white flex flex-col items-center justify-center text-center" style="--bg-from:#60a5fa;--bg-to:#3b82f6;">
              <div class="w-12 h-12 md:w-14 md:h-14 bg-white/20 rounded-xl flex items-center justify-center mb-3">
                <i class="fas fa-thermometer-half text-xl md:text-2xl"></i>
              </div>
              <p class="text-blue-50 text-xs md:text-sm tracking-wide">Sakit</p>
              <p class="text-3xl md:text-4xl font-extrabold mt-1" id="filterSakit">0</p>
            </div>
            <!-- Alpha -->
            <div class="stats-card hover-lift rounded-2xl p-5 md:p-6 text-white flex flex-col items-center justify-center text-center" style="--bg-from:#f87171;--bg-to:#ef4444;">
              <div class="w-12 h-12 md:w-14 md:h-14 bg-white/20 rounded-xl flex items-center justify-center mb-3">
                <i class="fas fa-times-circle text-xl md:text-2xl"></i>
              </div>
              <p class="text-red-50 text-xs md:text-sm tracking-wide">Alpha</p>
              <p class="text-3xl md:text-4xl font-extrabold mt-1" id="filterAlpha">0</p>
            </div>
          </div>

          <div class="table-container">
            <div class="flex items-center justify-between p-4 border-b">
              <h3 class="text-lg font-semibold text-gray-800">Data Absensi</h3>
              <div class="flex items-center space-x-4">
                <span class="text-sm text-gray-600">Auto refresh: 30s</span>
                <button id="toggleTableBtn" onclick="toggleAbsensiTable()" class="btn-success text-white px-4 py-2 rounded-lg font-medium flex items-center space-x-2">
                  <i class="fas fa-eye"></i><span>Tampilkan</span>
                </button>
                <button onclick="loadRekapData()" class="btn-primary text-white px-4 py-2 rounded-lg font-medium flex items-center space-x-2">
                  <i class="fas fa-refresh"></i><span>Refresh</span>
                </button>
              </div>
            </div>
            <div id="absensiTableContainer" class="overflow-x-auto hidden">
              <table class="w-full">
                <thead class="table-header">
                  <tr>
                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Nama</th>
                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Kelas</th>
                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Mata Pelajaran</th>
                    <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Status</th>
                  </tr>
                </thead>
                <tbody id="rekapTableBody">
                  <tr>
                    <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                      <i class="fas fa-chart-bar text-2xl mb-2 block"></i>Klik "Tampilkan" untuk melihat data absensi
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- Data Siswa -->
      <section id="data-siswa-section" class="animate-fade-in hidden">
        <div class="bg-white/80 backdrop-blur-md rounded-2xl card-shadow p-6">
          <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-gray-800 flex items-center mb-4 sm:mb-0">
              <i class="fas fa-users text-purple-600 mr-3"></i>Data Siswa
            </h2>
            <div class="flex flex-col sm:flex-row gap-3">
              <button onclick="loadDataSiswa()" class="btn-primary text-white px-6 py-3 rounded-xl font-semibold flex items-center space-x-2">
                <i class="fas fa-sync-alt"></i><span>Refresh Data</span>
              </button>
              <button onclick="openDataSiswaSpreadsheet()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-xl font-semibold flex items-center space-x-2 transition-all duration-300">
                <i class="fas fa-table"></i><span>Spreadsheet</span>
              </button>
            </div>
          </div>

          <div class="table-container">
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="table-header">
                  <tr>
                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">NIS</th>
                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Nama Siswa</th>
                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Kelas</th>
                  </tr>
                </thead>
                <tbody id="dataSiswaTableBody">
                  <tr>
                    <td colspan="3" class="px-4 py-8 text-center text-gray-500">
                      <i class="fas fa-users text-2xl mb-2 block"></i>Klik "Refresh Data" untuk menampilkan data siswa
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- Mata Pelajaran -->
      <section id="mata-pelajaran-section" class="animate-fade-in hidden">
        <div class="bg-white/80 backdrop-blur-md rounded-2xl card-shadow p-6">
          <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
            <i class="fas fa-book text-orange-600 mr-3"></i>Mata Pelajaran
          </h2>

          <div class="bg-gray-50/80 rounded-xl p-6 mb-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Tambah Mata Pelajaran Baru</h3>
            <div class="flex flex-col md:flex-row gap-4">
              <input id="newMapelInput" type="text" placeholder="Nama Mata Pelajaran" class="form-input flex-1 px-4 py-3 rounded-xl bg-white">
              <button onclick="tambahMataPelajaran()" class="btn-warning text-white px-8 py-3 rounded-xl font-semibold flex items-center justify-center space-x-2">
                <i class="fas fa-plus"></i><span>Tambah</span>
              </button>
            </div>
          </div>

          <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-3">
            <div class="flex flex-col sm:flex-row gap-3">
              <button onclick="loadMataPelajaran()" class="btn-primary text-white px-6 py-3 rounded-xl font-semibold flex items-center space-x-2">
                <i class="fas fa-sync-alt"></i><span>Refresh Data</span>
              </button>
              <button onclick="openMataPelajaranSpreadsheet()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-xl font-semibold flex items-center space-x-2 transition-all duration-300">
                <i class="fas fa-table"></i><span>Spreadsheet</span>
              </button>
            </div>
          </div>

          <div class="table-container">
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="table-header">
                  <tr>
                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">No</th>
                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Mata Pelajaran</th>
                    <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Status</th>
                  </tr>
                </thead>
                <tbody id="mataPelajaranTableBody">
                  <tr>
                    <td colspan="3" class="px-4 py-8 text-center text-gray-500">
                      <i class="fas fa-book text-2xl mb-2 block"></i>Klik "Refresh Data" untuk menampilkan mata pelajaran
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- KepSek -->
      <section id="kepsek-section" class="animate-fade-in hidden">
        <div class="bg-white/80 backdrop-blur-md rounded-2xl card-shadow p-6">
          <div class="flex items-start md:items-center justify-between flex-col md:flex-row gap-3 mb-4">
            <h2 class="text-2xl font-bold text-gray-800 flex items-center">
              <i class="fas fa-user-tie text-indigo-600 mr-3"></i>Daftar Ketidakhadiran Siswa
            </h2>
            <div class="text-sm text-gray-600">
              Hari ini: <span id="kepsekDate" class="font-semibold text-gray-800">-</span>
            </div>
          </div>
          <p class="text-gray-600 mb-4">Menampilkan data Izin, Sakit, dan Alpha hari ini. Diperbarui otomatis tiap 30 detik.</p>

          <!-- KOTAK RINGKASAN KELAS -->
          <div id="kepsekSummaryContainer" class="flex flex-col space-y-3 mb-6">
            <!-- diisi via JS -->
          </div>

          <!-- List ketidakhadiran per kelas -->
          <div id="kepsekContainer" class="space-y-6">
            <div class="text-center text-gray-500 py-8 bg-white rounded-xl border border-dashed">
              <i class="fas fa-spinner fa-spin mb-2 text-xl block"></i>
              Memuat data ketidakhadiran hari ini...
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Loading Modal -->
  <div id="loadingModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-2xl p-8 text-center card-shadow">
      <div class="loading-spinner mx-auto mb-4"></div>
      <p class="text-gray-600 font-medium">Memproses data...</p>
    </div>
  </div>

  <!-- Progress Modal -->
  <div id="progressModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-2xl p-8 text-center card-shadow max-w-md w-full mx-4">
      <div class="mb-6">
        <i class="fas fa-upload text-4xl text-blue-600 mb-4"></i>
        <h3 class="text-xl font-bold text-gray-800 mb-2">Mengirim Data Absensi</h3>
        <p class="text-gray-600">Mohon tunggu, sedang mengirim data...</p>
      </div>
      <div class="mb-4">
        <div class="flex justify-between text-sm text-gray-600 mb-2">
          <span id="progressText">Memulai...</span>
          <span id="progressPercent">0%</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-3">
          <div id="progressBar" class="bg-gradient-to-r from-blue-500 to-blue-600 h-3 rounded-full transition-all duration-300" style="width:0%"></div>
        </div>
      </div>
      <div class="text-sm text-gray-500">
        <span id="progressDetail">Bersiap mengirim data...</span>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>

  <script>
    // Global data
    let dataSiswa = [];
    let rekapData = [];
    let mataPelajaranData = [];

    // URLs
    const ABSENSI_URL = 'https://script.google.com/macros/s/AKfycbyFw0f0-Q5TK65-407hcsnnwRWex8XHr0800nHNknPOm2ejH2N1k6SuNaDpsJGJDE0/exec';
    const DATA_SISWA_URL = 'https://script.google.com/macros/s/AKfycbyE50wAYAx4CLgTCmllArP_CukFceHHAfKG4Xz6vH8xp171VFWHunyMLtWcm_rkFTOH/exec';
    const MATA_PELAJARAN_URL = 'https://script.google.com/macros/s/AKfycbzRicab9NlcGVKVTi1LHFbcBhVOz2rkYKokZ4KK131C8R3zEbyZZF3QLU6KNMbNAXs/exec';

    document.addEventListener('DOMContentLoaded', () => {
      if (localStorage.getItem('isLoggedIn') === 'true') showMainApp();
      document.getElementById('loginForm').addEventListener('submit', handleLogin);

      updateDateTime();
      setInterval(updateDateTime, 1000);
      setTodayDate();
      updateKepsekDateLabel();

      // Auto refresh 30s
      setInterval(() => {
        const rekapVisible = !document.getElementById('rekap-section').classList.contains('hidden');
        const dashVisible = !document.getElementById('dashboard-section').classList.contains('hidden');
        const kepsekVisible = !document.getElementById('kepsek-section').classList.contains('hidden');
        if (rekapVisible || dashVisible || kepsekVisible) loadRekapData();
      }, 30000);
    });

    // LOGIN
    function handleLogin(e){
      e.preventDefault();
      const u = document.getElementById('username').value;
      const p = document.getElementById('password').value;
      const errorDiv = document.getElementById('loginError');
      errorDiv.classList.add('hidden');
      if (u === 'admin' && p === 'milik1234'){
        localStorage.setItem('isLoggedIn','true');
        showMainApp();
        showToast('Login berhasil! Selamat datang di Sistem Absensi','success');
      } else {
        errorDiv.classList.remove('hidden');
        showToast('Username atau password salah!','error');
        document.getElementById('password').value = '';
        setTimeout(()=>errorDiv.classList.add('hidden'), 5000);
      }
    }

    function showMainApp(){
      document.getElementById('loginPage').classList.add('hidden');
      document.getElementById('mainApp').classList.remove('hidden');
      refreshAllData();
    }

    function logout(){
      if(confirm('Apakah Anda yakin ingin keluar?')){
        localStorage.removeItem('isLoggedIn');
        document.getElementById('mainApp').classList.add('hidden');
        document.getElementById('loginPage').classList.remove('hidden');
        document.getElementById('loginForm').reset();
        showToast('Anda telah keluar dari sistem','success');
      }
    }

    function togglePassword(){
      const el = document.getElementById('password');
      const icon = document.getElementById('passwordToggleIcon');
      if(el.type === 'password'){ el.type = 'text'; icon.className='fas fa-eye-slash'; }
      else { el.type='password'; icon.className='fas fa-eye'; }
    }

    function updateDateTime(){
      const now = new Date();
      const options = { timeZone:'Asia/Jakarta', weekday:'long', year:'numeric', month:'long', day:'numeric', hour:'2-digit', minute:'2-digit', second:'2-digit' };
      const el = document.getElementById('currentDateTime');
      if (el) el.textContent = now.toLocaleDateString('id-ID', options);
    }

    function updateKepsekDateLabel(){
      const now = new Date();
      const opts = { timeZone:'Asia/Jakarta', year:'numeric', month:'long', day:'numeric' };
      const label = document.getElementById('kepsekDate');
      if (label) label.textContent = now.toLocaleDateString('id-ID', opts);
    }

    function setTodayDate(){
      const today = new Date();
      const formatted = today.toISOString().split('T')[0];
      const input = document.getElementById('tanggalAbsen');
      if (input) input.value = formatted;
    }

    // NAV
    function showSection(section){
      document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));
      document.getElementById(section + '-section').classList.remove('hidden');
      document.querySelectorAll('.nav-item').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.nav-item').forEach(btn => {
        if (btn.onclick && btn.onclick.toString().includes(`'${section}'`)) btn.classList.add('active');
      });
      if (section === 'kepsek') {
        updateKepsekDateLabel();
        populateKepsekView();
      }
    }

    // REFRESH
    async function refreshAllData(){
      showLoading(true);
      try{
        await Promise.all([loadDataSiswa(), loadMataPelajaran(), loadRekapData()]);
        showToast('Semua data berhasil diperbarui','success');
      }catch(e){
        console.error(e);
        showToast('Gagal memperbarui beberapa data','error');
      }
      showLoading(false);
    }

    // FETCH
    async function loadDataSiswa(){
      const r = await fetch(DATA_SISWA_URL);
      dataSiswa = await r.json();
      populateDataSiswaTable();
      populateKelasFilter();
      populateRekapKelasFilter();
      populateKepsekSummary(); // update ringkasan kelas
    }

    async function loadMataPelajaran(){
      const r = await fetch(MATA_PELAJARAN_URL);
      const result = await r.json();
      if (result.status === 'success'){
        mataPelajaranData = result.data;
        populateMataPelajaranTable();
        populateMataPelajaranDropdowns();
      } else {
        throw new Error(result.message);
      }
    }

    async function loadRekapData(){
      const r = await fetch(ABSENSI_URL);
      rekapData = await r.json();
      updateStatistik();
      populateRekapTable();
      populateRecentActivity();
      populateKepsekView(); // sync KepSek
    }

    // HELPERS: Status badge + Nama fallback (hindari "undefined")
    function getStatusBadge(k){
      const m = {
        'H':'<span class="px-2 py-1 bg-green-100 text-green-800 text-xs font-semibold rounded-full">Hadir</span>',
        'I':'<span class="px-2 py-1 bg-yellow-100 text-yellow-800 text-xs font-semibold rounded-full">Izin</span>',
        'S':'<span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs font-semibold rounded-full">Sakit</span>',
        'A':'<span class="px-2 py-1 bg-red-100 text-red-800 text-xs font-semibold rounded-full">Alpha</span>'
      };
      return m[k] || '<span class="px-2 py-1 bg-gray-100 text-gray-800 text-xs font-semibold rounded-full">-</span>';
    }
    function getNamaByNIS(nis){
      const s = dataSiswa.find(x => String(x.nis) === String(nis));
      return s ? s.nama : '';
    }
    function displayNama(item){
      const nama = item['Nama Lengkap'];
      if (nama && String(nama).toLowerCase() !== 'undefined') return nama;
      const byNis = getNamaByNIS(item.NIS);
      return byNis && String(byNis).toLowerCase() !== 'undefined' ? byNis : '-';
    }

    // DASHBOARD
    function updateStatistik(){
      const filterKelas = document.getElementById('filterKelas')?.value || '';
      let filtered = rekapData;
      if (filterKelas) filtered = rekapData.filter(i => i.Kelas === filterKelas);
      const stats = {
        hadir: filtered.filter(i => i.Keterangan === 'H').length,
        izin: filtered.filter(i => i.Keterangan === 'I').length,
        sakit: filtered.filter(i => i.Keterangan === 'S').length,
        alpha: filtered.filter(i => i.Keterangan === 'A').length,
      };
      document.getElementById('totalHadir').textContent = stats.hadir;
      document.getElementById('totalIzin').textContent = stats.izin;
      document.getElementById('totalSakit').textContent = stats.sakit;
      document.getElementById('totalAlpha').textContent = stats.alpha;
    }

    function populateRecentActivity(){
      const tbody = document.getElementById('recentActivityTable');
      if (!tbody) return;
      tbody.innerHTML = '';
      const recent = rekapData.slice(-5).reverse();
      if (recent.length === 0){
        tbody.innerHTML = `<tr><td colspan="4" class="px-4 py-8 text-center text-gray-500"><i class="fas fa-clock text-2xl mb-2 block"></i>Belum ada aktivitas</td></tr>`;
        return;
      }
      recent.forEach(item => {
        tbody.insertAdjacentHTML('beforeend', `
          <tr class="border-b border-gray-100 hover:bg-gray-50">
            <td class="px-4 py-3 text-sm text-gray-600">${item['Tanggal Absen']}</td>
            <td class="px-4 py-3 text-sm font-medium text-gray-800">${displayNama(item)}</td>
            <td class="px-4 py-3 text-sm text-gray-600">${item.Kelas}</td>
            <td class="px-4 py-3 text-center">${getStatusBadge(item.Keterangan)}</td>
          </tr>
        `);
      });
    }

    // DATA SISWA
    function populateDataSiswaTable(){
      const tbody = document.getElementById('dataSiswaTableBody');
      if (!tbody) return;
      tbody.innerHTML = '';
      dataSiswa.forEach(s => {
        tbody.insertAdjacentHTML('beforeend', `
          <tr class="border-b border-gray-100 hover:bg-gray-50">
            <td class="px-4 py-3 text-sm font-medium text-gray-800">${s.nis}</td>
            <td class="px-4 py-3 text-sm text-gray-600">${s.nama}</td>
            <td class="px-4 py-3 text-sm text-gray-600">${s.kelas}</td>
          </tr>
        `);
      });
    }
    function populateKelasFilter(){
      const el = document.getElementById('kelasSiswa');
      if (!el) return;
      const set = new Set(dataSiswa.map(s => s.kelas));
      el.innerHTML = '<option value="">Pilih Kelas</option>';
      set.forEach(k => el.insertAdjacentHTML('beforeend', `<option value="${k}">${k}</option>`));
    }
    function populateRekapKelasFilter(){
      const el = document.getElementById('filterKelas');
      if (!el) return;
      const set = new Set(dataSiswa.map(s => s.kelas));
      el.innerHTML = '<option value="">Semua Kelas</option>';
      set.forEach(k => el.insertAdjacentHTML('beforeend', `<option value="${k}">${k}</option>`));
    }
    function populateMataPelajaranDropdowns(){
      const mp = document.getElementById('mataPelajaran');
      const fmp = document.getElementById('filterMataPelajaran');
      if (!mp || !fmp) return;
      mp.innerHTML = '<option value="">Pilih Mata Pelajaran</option>';
      fmp.innerHTML = '<option value="">Semua Mata Pelajaran</option>';
      mataPelajaranData.forEach(m => {
        mp.insertAdjacentHTML('beforeend', `<option value="${m}">${m}</option>`);
        fmp.insertAdjacentHTML('beforeend', `<option value="${m}">${m}</option>`);
      });
    }
    function populateMataPelajaranTable(){
      const tbody = document.getElementById('mataPelajaranTableBody');
      if (!tbody) return;
      tbody.innerHTML = '';
      if (mataPelajaranData.length === 0){
        tbody.innerHTML = `<tr><td colspan="3" class="px-4 py-8 text-center text-gray-500"><i class="fas fa-book text-2xl mb-2 block"></i>Belum ada mata pelajaran</td></tr>`;
        return;
      }
      mataPelajaranData.forEach((m,i) => {
        tbody.insertAdjacentHTML('beforeend', `
          <tr class="border-b border-gray-100 hover:bg-gray-50">
            <td class="px-4 py-3 text-sm font-medium text-gray-800">${i+1}</td>
            <td class="px-4 py-3 text-sm text-gray-600">${m}</td>
            <td class="px-4 py-3 text-center">
              <span class="px-3 py-1 bg-green-100 text-green-800 text-sm font-medium rounded-lg"><i class="fas fa-check-circle mr-1"></i>Aktif</span>
            </td>
          </tr>
        `);
      });
    }

    // REKAP TABEL
    function populateRekapTable(){
      const tbody = document.getElementById('rekapTableBody');
      if (!tbody) return;
      tbody.innerHTML = '';
      if (rekapData.length === 0){
        tbody.innerHTML = `<tr><td colspan="6" class="px-4 py-8 text-center text-gray-500"><i class="fas fa-chart-bar text-2xl mb-2 block"></i>Belum ada data absensi</td></tr>`;
        return;
      }
      rekapData.forEach(item => {
        tbody.insertAdjacentHTML('beforeend', `
          <tr class="border-b border-gray-100 hover:bg-gray-50">
            <td class="px-4 py-3 text-sm text-gray-600">${displayNama(item)}</td>
            <td class="px-4 py-3 text-sm text-gray-600">${item.Kelas}</td>
            <td class="px-4 py-3 text-sm text-gray-600">${item['Mata Pelajaran']}</td>
            <td class="px-4 py-3 text-center">${getStatusBadge(item.Keterangan)}</td>
          </tr>
        `);
      });
    }

    function toggleAbsensiTable(){
      const cont = document.getElementById('absensiTableContainer');
      const btn = document.getElementById('toggleTableBtn');
      const stats = document.getElementById('filterStatsContainer');
      if (cont.classList.contains('hidden')){
        cont.classList.remove('hidden'); stats.classList.remove('hidden');
        btn.innerHTML = '<i class="fas fa-eye-slash"></i><span>Sembunyikan</span>';
        btn.className = 'btn-warning text-white px-4 py-2 rounded-lg font-medium flex items-center space-x-2';
        if (rekapData.length === 0) loadRekapData().then(()=>updateFilterStatistik());
        else { populateRekapTable(); updateFilterStatistik(); }
      } else {
        cont.classList.add('hidden'); stats.classList.add('hidden');
        btn.innerHTML = '<i class="fas fa-eye"></i><span>Tampilkan</span>';
        btn.className = 'btn-success text-white px-4 py-2 rounded-lg font-medium flex items-center space-x-2';
      }
    }

    function updateFilterStatistik(){
      const kelas = document.getElementById('filterKelas').value;
      const mp = document.getElementById('filterMataPelajaran').value;
      const dari = document.getElementById('filterDariTanggal').value;
      const sampai = document.getElementById('filterSampaiTanggal').value;

      let filtered = rekapData;
      if (kelas) filtered = filtered.filter(i => i.Kelas === kelas);
      if (mp) filtered = filtered.filter(i => i['Mata Pelajaran'] === mp);
      if (dari) filtered = filtered.filter(i => new Date(i['Tanggal Absen']) >= new Date(dari));
      if (sampai) filtered = filtered.filter(i => new Date(i['Tanggal Absen']) <= new Date(sampai));

      const s = {
        hadir: filtered.filter(i => i.Keterangan === 'H').length,
        izin: filtered.filter(i => i.Keterangan === 'I').length,
        sakit: filtered.filter(i => i.Keterangan === 'S').length,
        alpha: filtered.filter(i => i.Keterangan === 'A').length,
      };
      document.getElementById('filterHadir').textContent = s.hadir;
      document.getElementById('filterIzin').textContent = s.izin;
      document.getElementById('filterSakit').textContent = s.sakit;
      document.getElementById('filterAlpha').textContent = s.alpha;

      return filtered;
    }

    async function applyRekapFilter(){
      if (rekapData.length === 0) await loadRekapData();
      const filtered = updateFilterStatistik();
      const tbody = document.getElementById('rekapTableBody');
      tbody.innerHTML = '';
      if (filtered.length === 0){
        tbody.innerHTML = `<tr><td colspan="6" class="px-4 py-8 text-center text-gray-500"><i class="fas fa-search text-2xl mb-2 block"></i>Tidak ada data yang sesuai dengan filter</td></tr>`;
      } else {
        filtered.forEach(item => {
          tbody.insertAdjacentHTML('beforeend', `
            <tr class="border-b border-gray-100 hover:bg-gray-50">
              <td class="px-4 py-3 text-sm text-gray-600">${displayNama(item)}</td>
              <td class="px-4 py-3 text-sm text-gray-600">${item.Kelas}</td>
              <td class="px-4 py-3 text-sm text-gray-600">${item['Mata Pelajaran']}</td>
              <td class="px-4 py-3 text-center">${getStatusBadge(item.Keterangan)}</td>
            </tr>
          `);
        });
      }
      const stats = document.getElementById('filterStatsContainer');
      const cont = document.getElementById('absensiTableContainer');
      const btn = document.getElementById('toggleTableBtn');
      if (stats.classList.contains('hidden')){
        stats.classList.remove('hidden'); cont.classList.remove('hidden');
        btn.innerHTML = '<i class="fas fa-eye-slash"></i><span>Sembunyikan</span>';
        btn.className = 'btn-warning text-white px-4 py-2 rounded-lg font-medium flex items-center space-x-2';
      }
      updateStatistik();
      const kelas = document.getElementById('filterKelas').value;
      const mp = document.getElementById('filterMataPelajaran').value;
      const dari = document.getElementById('filterDariTanggal').value;
      const sampai = document.getElementById('filterSampaiTanggal').value;
      const info = [];
      if (kelas) info.push(`Kelas: ${kelas}`);
      if (mp) info.push(`Mapel: ${mp}`);
      if (dari) info.push(`Dari: ${dari}`);
      if (sampai) info.push(`Sampai: ${sampai}`);
      showToast(`Menampilkan ${filtered.length} data hasil filter${info.length ? ' ('+info.join(', ')+')' : ''}`,'success');
    }

    // KEPSEK: Ringkasan kelas + ketidakhadiran
    function populateKepsekSummary(){
      const box = document.getElementById('kepsekSummaryContainer');
      if (!box) return;
      box.innerHTML = '';
      if (!Array.isArray(dataSiswa) || dataSiswa.length === 0){
        box.innerHTML = `<div class="col-span-2 text-center text-gray-500 py-4 bg-white rounded-xl border border-dashed">Belum ada data siswa</div>`;
        return;
      }
      const counts = {};
      dataSiswa.forEach(s => { counts[s.kelas] = (counts[s.kelas] || 0) + 1; });
      Object.keys(counts).sort().forEach(kelas => {
        box.insertAdjacentHTML('beforeend', `
          <div class="w-full rounded-xl bg-white px-4 py-3 border border-gray-100 card-shadow flex items-center">
            <div class="flex items-center space-x-3">
              <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-indigo-500 to-purple-600 text-white flex items-center justify-center">
                <i class="fas fa-chalkboard text-sm"></i>
              </div>
              <p class="text-base font-semibold text-gray-800">Kelas ${kelas}</p>
            </div>
            <div class="ml-auto">
              <div class="w-9 h-9 rounded-full bg-gray-100 text-gray-800 font-bold flex items-center justify-center">${counts[kelas]}</div>
            </div>
          </div>
        `);
      });
    }

    function populateKepsekView(){
      populateKepsekSummary(); // pastikan ringkasan terisi
      const wrap = document.getElementById('kepsekContainer');
      if (!wrap) return;
      wrap.innerHTML = '';

      if (!Array.isArray(rekapData) || rekapData.length === 0){
        wrap.innerHTML = `<div class="text-center text-gray-500 py-8 bg-white rounded-xl border border-dashed"><i class="fas fa-info-circle mb-2 text-xl block"></i>Tidak ada data untuk ditampilkan</div>`;
        return;
      }

      // Filter hari ini & bukan H
      const today = new Date();
      const start = new Date(today.getFullYear(), today.getMonth(), today.getDate());
      const end = new Date(today.getFullYear(), today.getMonth(), today.getDate()+1);

      const todayAbsences = rekapData.filter(it => {
        const d = new Date(it['Tanggal Absen']);
        return (it.Keterangan !== 'H') && d >= start && d < end;
      });

      if (todayAbsences.length === 0){
        wrap.innerHTML = `<div class="text-center text-green-700 py-10 bg-green-50 rounded-xl border border-green-200">
            <i class="fas fa-check-circle text-2xl mb-2"></i>
            <p class="font-semibold">Semua siswa hadir hari ini ð</p>
          </div>`;
        return;
      }

      // Group by kelas
      const byClass = {};
      todayAbsences.forEach(it => {
        const k = it.Kelas || 'Tanpa Kelas';
        if (!byClass[k]) byClass[k] = [];
        byClass[k].push(it);
      });

      Object.keys(byClass).sort().forEach(kelas => {
        const list = byClass[kelas];
        const card = document.createElement('div');
        card.className = 'bg-white rounded-2xl card-shadow border border-gray-100';
        card.innerHTML = `
          <div class="flex items-center justify-between p-4 border-b">
            <div class="flex items-center space-x-3">
              <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-indigo-500 to-purple-600 text-white flex items-center justify-center">
                <i class="fas fa-chalkboard-user"></i>
              </div>
              <div>
                <h3 class="text-lg font-bold text-gray-800">Kelas ${kelas}</h3>
                <p class="text-sm text-gray-500">${list.length} siswa tidak hadir</p>
              </div>
            </div>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="table-header">
                <tr>
                  <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Nama</th>
                  <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Kelas</th>
                  <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Status</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-100">
                ${list.map(it => `
                  <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3 text-sm font-medium text-gray-800">${displayNama(it)}</td>
                    <td class="px-4 py-3 text-sm text-gray-600">${it.Kelas}</td>
                    <td class="px-4 py-3 text-center">${getStatusBadge(it.Keterangan)}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        `;
        wrap.appendChild(card);
      });
    }

    // ABSENSI FLOW
    function filterAbsensi(){
      const kelas = document.getElementById('kelasSiswa').value;
      const mp = document.getElementById('mataPelajaran').value;
      const tanggal = document.getElementById('tanggalAbsen').value;
      if (!kelas || !mp || !tanggal){ showToast('Mohon pilih Kelas, Mata Pelajaran, dan Tanggal','error'); return; }
      const filtered = dataSiswa.filter(s => s.kelas === kelas);
      populateAbsensiTable(filtered, mp, tanggal);
      document.getElementById('absensiDataContainer').classList.remove('hidden');
    }

    function populateAbsensiTable(list, mp, tgl){
      const tbody = document.getElementById('absensiTableBody');
      tbody.innerHTML = '';
      list.forEach(s => {
        tbody.insertAdjacentHTML('beforeend', `
          <tr class="border-b border-gray-100 hover:bg-gray-50">
            <td class="px-4 py-3 text-sm font-medium text-gray-800">${s.nis}</td>
            <td class="px-4 py-3 text-sm text-gray-600">${s.nama}</td>
            <td class="px-4 py-3 text-center"><input type="checkbox" class="keterangan-checkbox w-5 h-5 text-green-600 rounded focus:ring-green-500" data-nis="${s.nis}" data-nama="${s.nama}" data-kelas="${s.kelas}" data-keterangan="H" onchange="handleCheckboxChange(this)"></td>
            <td class="px-4 py-3 text-center"><input type="checkbox" class="keterangan-checkbox w-5 h-5 text-yellow-600 rounded focus:ring-yellow-500" data-nis="${s.nis}" data-nama="${s.nama}" data-kelas="${s.kelas}" data-keterangan="I" onchange="handleCheckboxChange(this)"></td>
            <td class="px-4 py-3 text-center"><input type="checkbox" class="keterangan-checkbox w-5 h-5 text-blue-600 rounded focus:ring-blue-500" data-nis="${s.nis}" data-nama="${s.nama}" data-kelas="${s.kelas}" data-keterangan="S" onchange="handleCheckboxChange(this)"></td>
            <td class="px-4 py-3 text-center"><input type="checkbox" class="keterangan-checkbox w-5 h-5 text-red-600 rounded focus:ring-red-500" data-nis="${s.nis}" data-nama="${s.nama}" data-kelas="${s.kelas}" data-keterangan="A" onchange="handleCheckboxChange(this)"></td>
          </tr>
        `);
      });
    }

    function handleCheckboxChange(checkbox){
      const nis = checkbox.dataset.nis;
      document.querySelectorAll(`input[data-nis="${nis}"]`).forEach(cb => { if (cb !== checkbox) cb.checked = false; });
    }

    function hadirSemua(){
      const all = document.querySelectorAll('.keterangan-checkbox');
      const hadir = document.querySelectorAll('input[data-keterangan="H"]');
      all.forEach(cb => cb.checked = false);
      hadir.forEach(cb => cb.checked = true);
      showToast('Semua siswa telah diatur sebagai Hadir','success');
    }

    async function simpanSemuaAbsensi(){
      const checked = document.querySelectorAll('.keterangan-checkbox:checked');
      const mp = document.getElementById('mataPelajaran').value;
      const tgl = document.getElementById('tanggalAbsen').value;
      if (checked.length === 0){ showToast('Pilih keterangan untuk siswa terlebih dahulu','error'); return; }

      let berhasil=0, gagal=0;
      const total = checked.length;

      showProgressModal(true);
      updateProgress(0, total, 'Memulai pengiriman data...');

      for (let i=0; i<checked.length; i++){
        const cb = checked[i];
        const { nis, nama, kelas } = cb.dataset;
        const ket = cb.dataset.keterangan;
        try{
          updateProgress(i, total, `Mengirim data ${nama}...`);
          await kirimAbsensi(nis, nama, kelas, mp, tgl, ket);
          berhasil++;
          updateProgress(i+1, total, `Berhasil mengirim data ${nama}`);
        }catch(e){
          gagal++;
          updateProgress(i+1, total, `Gagal mengirim data ${nama}`);
        }
        await new Promise(r => setTimeout(r, 200));
      }
      updateProgress(total, total, 'Selesai mengirim semua data');
      setTimeout(async ()=> {
        showProgressModal(false);
        if (berhasil>0){
          showToast(`${berhasil} absensi berhasil disimpan${gagal>0?`, ${gagal} gagal`:''}`,'success');
          document.getElementById('absensiForm').reset();
          setTodayDate();
          document.getElementById('absensiDataContainer').classList.add('hidden');
          await loadRekapData();
        } else {
          showToast('Tidak ada absensi yang berhasil disimpan','error');
        }
      }, 1000);
    }

    async function kirimAbsensi(nis, nama, kelas, mp, tgl, ket){
      const fd = new FormData();
      fd.append('NIS', nis);
      fd.append('Nama Lengkap', nama);
      fd.append('Kelas', kelas);
      fd.append('Tanggal Absen', tgl);
      fd.append('Mata Pelajaran', mp);
      fd.append('Keterangan', ket);
      const r = await fetch(ABSENSI_URL, { method:'POST', body: fd });
      const result = await r.json();
      if (result.status !== 'success') throw new Error(result.message);
      return result;
    }

    // UI helpers
    function showLoading(show){
      const m = document.getElementById('loadingModal');
      if (show) m.classList.remove('hidden'); else m.classList.add('hidden');
    }
    function showProgressModal(show){
      const m = document.getElementById('progressModal');
      if (show) m.classList.remove('hidden'); else m.classList.add('hidden');
    }
    function updateProgress(current, total, message){
      const pct = total === 0 ? 0 : Math.round((current/total)*100);
      document.getElementById('progressBar').style.width = pct + '%';
      document.getElementById('progressPercent').textContent = pct + '%';
      document.getElementById('progressText').textContent = `${current} dari ${total}`;
      document.getElementById('progressDetail').textContent = message || '';
    }

    // Spreadsheet
    function openRekapSpreadsheet(){ window.open('https://docs.google.com/spreadsheets/d/1QQ5KufpfZx_4LcdflC7w944Gml9Lh-nCI6ZEwau9hl8/edit?usp=sharing','_blank'); showToast('Membuka spreadsheet rekap absensi...','success'); }
    function openDataSiswaSpreadsheet(){ window.open('https://docs.google.com/spreadsheets/d/1v4qlJg1jpDD3mzg5rBiR4SoCY-nJd20sbk2JYhwR8Yk/edit?usp=sharing','_blank'); showToast('Membuka spreadsheet data siswa...','success'); }
    function openMataPelajaranSpreadsheet(){ window.open('https://docs.google.com/spreadsheets/d/1_fR71YY0j7627CLlx9bmzhh2QfPdngwCPaANC72jT4M/edit?usp=sharing','_blank'); showToast('Membuka spreadsheet mata pelajaran...','success'); }

    // Toast
    function showToast(message, type){
      const c = document.getElementById('toastContainer');
      const d = document.createElement('div');
      const bg = type==='success' ? 'bg-green-500' : 'bg-red-500';
      const icon = type==='success' ? 'fas fa-check-circle' : 'fas fa-exclamation-circle';
      d.className = `${bg} text-white px-6 py-4 rounded-xl shadow-lg flex items-center space-x-3 animate-fade-in`;
      d.innerHTML = `<i class="${icon}"></i><span class="font-medium">${message}</span>`;
      c.appendChild(d);
      setTimeout(()=>d.remove(), 5000);
    }
  </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97e6e7c8a2aa4d96',t:'MTc1Nzc1ODc1Ny4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
